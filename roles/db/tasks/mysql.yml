# /*
#  * Copyright (C) 2018 Amsterdam University of Applied Sciences (AUAS)
#  *
#  * This software is distributed under the terms of the
#  * GNU General Public Licence version 3 (GPL) version 3,
#  * copied verbatim in the file "LICENSE"
#  */

--- # Install mariadb via ansible on centOS
- name: Add official MariaDB repository
  become: yes
  become_user: "{{ remote_privileged_user }}"
  yum_repository:
    name: MariaDB
    description: Official MariaDB repository
    baseurl: "https://yum.mariadb.org/10.1/centos7-amd64"
    gpgkey: https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
    gpgcheck: true
  tags: mariadb

- name: Install packages
  become: yes
  become_user: "{{ remote_privileged_user }}"
  package:
    name: "{{ item }}"
    state: installed
  with_items: 
    - MariaDB
    - MariaDB-server
    - MySQL-python
  notify: enable mariadb on reboot
  tags: mariadb

- name: Start mysql server and enable it on reboot
  become: true
  become_user: "{{ remote_privileged_user }}"
  service: name=mariadb state=started enabled=true #debian: mysql

- name: make sql directory at /var/lib/jiskefet
  file:
    path: /var/lib/jiskefet/sql
    state: directory
    owner: "{{ jiskefet_user }}"

- name: Copy my.cnf from local to remote
  copy:
    src: my.cnf
    dest: /etc/my.cnf
  become: true
  become_method: su
  become_user: "{{ remote_privileged_user }}"

- name: Copy create_db_charset_utf8mb4.sql from local to remote
  template: 
    src: create_db_charset_utf8mb4.sql.j2 
    dest: /var/lib/jiskefet/sql/create_db_charset_utf8mb4.sql

- name: Copy create_test_db_charset_utf8mb4.sql from local to remote
  template: 
    src: create_test_db_charset_utf8mb4.sql.j2 
    dest: /var/lib/jiskefet/sql/create_test_db_charset_utf8mb4.sql

- name: Update mysql root password for all root accounts
  become: yes
  become_user: "{{ remote_privileged_user }}"
  mysql_user:
    name: "{{ jiskefet_api_general_settings.TYPEORM_USERNAME }}"
    host: "{{ item }}"
    password: "{{ jiskefet_api_general_settings.TYPEORM_PASSWORD }}"
    login_user: "{{ jiskefet_api_general_settings.TYPEORM_USERNAME }}"
    login_password: "{{ jiskefet_api_general_settings.TYPEORM_PASSWORD }}"
    check_implicit_admin: yes
    priv: "*.*:ALL,GRANT"
  with_items:
    - "{{ ansible_hostname }}"
    - 127.0.0.1
    - ::1
    - localhost
    - "%"

- name: Create mysql "{{ jiskefet_api_optional_settings.TEST_DB_USERNAME }}" user
  become: yes
  become_user: "{{ remote_privileged_user }}"
  mysql_user:
    name: "{{ jiskefet_api_optional_settings.TEST_DB_USERNAME }}"
    host: "{{ item }}"
    password: "{{ jiskefet_api_optional_settings.TEST_DB_PASSWORD }}"
    login_user: "{{ jiskefet_api_general_settings.TYPEORM_USERNAME }}"
    login_password: "{{ jiskefet_api_general_settings.TYPEORM_PASSWORD }}"
    priv: "{{ jiskefet_api_optional_settings.TEST_DB_DATABASE }}.*:ALL,GRANT"
    state: present
    check_implicit_admin: yes
  with_items: 
    - "{{ ansible_hostname }}"
    - 127.0.0.1
    - ::1
    - localhost
    - "%"
  when: 
    not
    ((jiskefet_api_optional_settings.TEST_DB_USERNAME is undefined)
    or
    (jiskefet_api_optional_settings.TEST_DB_USERNAME is none)
    or
    (jiskefet_api_optional_settings.TEST_DB_USERNAME | trim == ''))

- name: Create main database
  ignore_errors: yes
  mysql_db: 
    login_user: '{{ jiskefet_api_general_settings.TYPEORM_USERNAME }}' 
    login_password: '{{ jiskefet_api_general_settings.TYPEORM_PASSWORD }}'
    state: import
    name: 'all'
    target: /var/lib/jiskefet/sql/create_db_charset_utf8mb4.sql
  notify: restart mysql

- name: Create test database
  ignore_errors: yes
  mysql_db: 
    login_user: '{{ jiskefet_api_general_settings.TYPEORM_USERNAME }}' 
    login_password: '{{ jiskefet_api_general_settings.TYPEORM_PASSWORD }}'
    state: import
    name: 'all'
    target: /var/lib/jiskefet/sql/create_test_db_charset_utf8mb4.sql
  notify: restart mysql
  when: 
    not
    ((jiskefet_api_optional_settings.TEST_DB_USERNAME is undefined)
    or
    (jiskefet_api_optional_settings.TEST_DB_USERNAME is none)
    or
    (jiskefet_api_optional_settings.TEST_DB_USERNAME | trim == ''))
...
